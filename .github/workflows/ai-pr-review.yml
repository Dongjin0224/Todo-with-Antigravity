name: AI PR Review

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]
    branches: ["main"]
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  review:
    if: ${{ !github.event.pull_request.draft }}
    runs-on: ubuntu-latest

    steps:
      - name: Generate AI review comment
        uses: actions/github-script@v7
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY || secrets.OPENAI_KEY }}
          OPENAI_MODEL: ${{ vars.OPENAI_MODEL || 'gpt-4.1-mini' }}
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const marker = "<!-- ai-pr-review -->";
            const { owner, repo } = context.repo;
            const pull_number = context.payload.pull_request.number;

            if (!process.env.OPENAI_API_KEY) {
              core.setFailed("Missing OPENAI_API_KEY secret.");
              return;
            }

            const pr = await github.rest.pulls.get({ owner, repo, pull_number });
            const files = await github.paginate(github.rest.pulls.listFiles, {
              owner,
              repo,
              pull_number,
              per_page: 100
            });

            const diffChunks = files
              .filter((f) => Boolean(f.patch))
              .map((f) => `### ${f.filename}\n\`\`\`diff\n${f.patch}\n\`\`\``);

            if (diffChunks.length === 0) {
              core.info("No patch content to review.");
              return;
            }

            const MAX_DIFF_CHARS = 120000;
            const diffText = diffChunks.join("\n\n").slice(0, MAX_DIFF_CHARS);

            const prompt = [
              `You are a strict senior code reviewer.`,
              `Review this pull request and focus on:`,
              `1) Bugs or logic errors`,
              `2) Security/privacy risks`,
              `3) Behavioral regressions`,
              `4) Missing tests and edge cases`,
              `Return concise markdown in this structure:`,
              `- Critical findings`,
              `- Major findings`,
              `- Minor findings`,
              `- Missing tests`,
              `If none, explicitly say 'No critical issues found.'`,
              ``,
              `PR title: ${pr.data.title}`,
              `PR body: ${pr.data.body || "(empty)"}`,
              ``,
              `Diff:`,
              diffText
            ].join("\n");

            const response = await fetch("https://api.openai.com/v1/responses", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                Authorization: `Bearer ${process.env.OPENAI_API_KEY}`
              },
              body: JSON.stringify({
                model: process.env.OPENAI_MODEL || "gpt-4.1-mini",
                input: prompt
              })
            });

            if (!response.ok) {
              const errText = await response.text();
              core.setFailed(`OpenAI API error: ${response.status} ${errText}`);
              return;
            }

            const result = await response.json();
            const reviewText = (result.output_text || "").trim();

            if (!reviewText) {
              core.setFailed("OpenAI returned an empty review.");
              return;
            }

            const body = [
              marker,
              "## AI PR Review",
              "",
              reviewText,
              "",
              `Model: \`${process.env.OPENAI_MODEL || "gpt-4.1-mini"}\``
            ].join("\n");

            const comments = await github.paginate(github.rest.issues.listComments, {
              owner,
              repo,
              issue_number: pull_number,
              per_page: 100
            });

            const previous = comments.find((c) => c.body && c.body.includes(marker));

            if (previous) {
              await github.rest.issues.updateComment({
                owner,
                repo,
                comment_id: previous.id,
                body
              });
              core.info(`Updated existing AI review comment: ${previous.id}`);
            } else {
              await github.rest.issues.createComment({
                owner,
                repo,
                issue_number: pull_number,
                body
              });
              core.info("Created new AI review comment.");
            }
